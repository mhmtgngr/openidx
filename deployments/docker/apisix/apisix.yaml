routes:
  # Simple CORS preflight handling
  - uri: /.*
    name: cors-preflight
    methods: ["OPTIONS"]
    plugins:
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "Content-Type,Authorization,X-Requested-With,Accept,Origin"
        max_age: 86400
    upstream:
      type: roundrobin
      nodes:
        "admin-api:8005": 1

  # Identity service
  - uri: /api/v1/identity/*
    name: identity-service
    plugins:
      limit-req:
        rate: 100
        burst: 50
        key: remote_addr
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "Content-Type,Authorization,X-Requested-With"
        max_age: 3600
    upstream:
      type: roundrobin
      nodes:
        "identity-service:8001": 1

  # Governance service
  - uri: /api/v1/governance/*
    name: governance-service
    plugins:
      limit-req:
        rate: 50
        burst: 25
        key: remote_addr
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "Content-Type,Authorization,X-Requested-With"
        max_age: 3600
    upstream:
      type: roundrobin
      nodes:
        "governance-service:8002": 1

  # Provisioning service
  - uri: /api/v1/provisioning/*
    name: provisioning-service
    plugins:
      limit-req:
        rate: 30
        burst: 15
        key: remote_addr
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "Content-Type,Authorization,X-Requested-With"
        max_age: 3600
    upstream:
      type: roundrobin
      nodes:
        "provisioning-service:8003": 1

  # Audit service
  - uri: /api/v1/audit/*
    name: audit-service
    plugins:
      limit-req:
        rate: 200
        burst: 100
        key: remote_addr
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "Content-Type,Authorization,X-Requested-With"
        max_age: 3600
    upstream:
      type: roundrobin
      nodes:
        "audit-service:8004": 1

  # OAuth/OIDC service - authorization and token endpoints
  - uri: /oauth/*
    name: oauth-service
    plugins:
      limit-req:
        rate: 100
        burst: 50
        key: remote_addr
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "Content-Type,Authorization,X-Requested-With,Accept,Origin"
        max_age: 3600
    upstream:
      type: roundrobin
      nodes:
        "oauth-service:8006": 1

  # OIDC discovery endpoints
  - uri: /.well-known/*
    name: oidc-discovery
    plugins:
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,OPTIONS"
        allow_headers: "Content-Type,Accept"
        max_age: 86400
    upstream:
      type: roundrobin
      nodes:
        "oauth-service:8006": 1

  # Access proxy service API
  - uri: /api/v1/access/*
    name: access-service
    plugins:
      limit-req:
        rate: 100
        burst: 50
        key: remote_addr
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "Content-Type,Authorization,X-Forwarded-Host,X-Forwarded-Uri,X-Forwarded-Method,X-Forwarded-For,Cookie"
        max_age: 3600
    upstream:
      type: roundrobin
      nodes:
        "access-service:8007": 1

  # Access proxy auth flow
  - uri: /access/.auth/*
    name: access-auth-flow
    plugins:
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,POST,OPTIONS"
        allow_headers: "Content-Type,Authorization,Cookie"
        max_age: 3600
    upstream:
      type: roundrobin
      nodes:
        "access-service:8007": 1

  # Guacamole remote access gateway (protected by forward-auth)
  - uri: /guacamole/*
    name: guacamole-gateway
    plugins:
      forward-auth:
        uri: "http://access-service:8007/api/v1/access/auth/decide"
        request_headers:
          - "Authorization"
          - "Cookie"
          - "X-Forwarded-For"
          - "X-Real-IP"
        upstream_headers:
          - "X-Forwarded-User"
          - "X-Forwarded-Email"
          - "X-Forwarded-Roles"
          - "X-Risk-Score"
    enable_websocket: true
    upstream:
      type: roundrobin
      nodes:
        "guacamole:8080": 1

  # Admin API (no auth for testing)
  - uri: /api/v1/*
    name: admin-api
    plugins:
      limit-req:
        rate: 50
        burst: 25
        key: remote_addr
      cors:
        allow_origins: "http://localhost:3000"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
        allow_headers: "Content-Type,Authorization,X-Requested-With,Accept,Origin"
        max_age: 3600
    upstream:
      type: roundrobin
      nodes:
        "admin-api:8005": 1

global_rules:
  - id: 1
    plugins:
      request-id: {}
#END
