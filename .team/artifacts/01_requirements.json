{
  "project_name": "WebAuthn Security Hardening",
  "summary": "Implement proper JWT-based authentication middleware and CSRF protection for WebAuthn credential management endpoints in internal/mfa/webauthn_handler.go to address critical security vulnerabilities at lines 515 and 525.",
  "user_stories": [
    {
      "id": "US-001",
      "as_a": "security administrator",
      "i_want": "all WebAuthn endpoints protected by JWT authentication middleware",
      "so_that": "unauthenticated actors cannot register, list, modify, or delete WebAuthn credentials",
      "priority": "critical",
      "acceptance_criteria": [
        "All POST/PUT/DELETE WebAuthn endpoints require valid JWT access token",
        "JWT is extracted from Authorization Bearer header",
        "Token validation uses existing internal/auth/middleware RBACMiddleware",
        "User ID from JWT claims matches requested user_id parameter",
        "Expired or invalid tokens return 401 Unauthorized"
      ]
    },
    {
      "id": "US-002",
      "as_a": "security administrator",
      "i_want": "CSRF protection on all state-changing WebAuthn endpoints",
      "so_that": "cross-site request forgery attacks cannot be executed against WebAuthn credential management",
      "priority": "critical",
      "acceptance_criteria": [
        "CSRF middleware applied to POST/PUT/DELETE endpoints",
        "Origin/Referer headers validated against trusted domain",
        "Double-submit cookie pattern with signed CSRF tokens",
        "SameSite cookies set to Strict mode",
        "GET requests exempted from CSRF checks"
      ]
    },
    {
      "id": "US-003",
      "as_a": "user",
      "i_want": "manage my own WebAuthn credentials securely",
      "so_that": "I can register, rename, and delete my security keys without risk of unauthorized access",
      "priority": "high",
      "acceptance_criteria": [
        "Can only access credentials belonging to authenticated user",
        "Ownership verification enforced before credential operations",
        "Audit logging for all credential modifications",
        "Clear error messages for permission denied scenarios"
      ]
    }
  ],
  "functional_requirements": [
    {
      "id": "FR-001",
      "title": "JWT Authentication Middleware Integration",
      "description": "Replace placeholder AuthMiddleware() at line 515 with proper JWT authentication using internal/auth/middleware RBACMiddleware. The middleware must validate JWT tokens from Authorization Bearer header, extract user claims from the token, and set user context for downstream handlers.",
      "service": "mfa-service"
    },
    {
      "id": "FR-002",
      "title": "CSRF Protection Implementation",
      "description": "Replace placeholder CSRFMiddleware() at line 525 with robust CSRF protection using double-submit cookie pattern or Origin/Referer header validation. Must integrate with existing internal/common/middleware/csrf.go CSRFProtection middleware.",
      "service": "mfa-service"
    },
    {
      "id": "FR-003",
      "title": "User Ownership Verification",
      "description": "Enhance credential management handlers (HandleListCredentials, HandleDeleteCredential, HandleRenameCredential) to verify the authenticated user from JWT context owns the requested user_id parameter. Prevent cross-user credential access.",
      "service": "mfa-service"
    },
    {
      "id": "FR-004",
      "title": "WebAuthn Endpoint Protection Configuration",
      "description": "Apply authentication and CSRF middleware chains to WebAuthn route group in RegisterRoutes method. Configure middleware order: CSRF -> JWT authentication -> handler.",
      "service": "mfa-service"
    }
  ],
  "non_functional_requirements": [
    {
      "id": "NFR-001",
      "category": "security",
      "requirement": "All state-changing WebAuthn endpoints must require valid JWT authentication",
      "metric": "100% of POST/PUT/DELETE endpoints protected"
    },
    {
      "id": "NFR-002",
      "category": "security",
      "requirement": "CSRF tokens must be cryptographically signed with per-request uniqueness",
      "metric": "CSRF token entropy >= 128 bits"
    },
    {
      "id": "NFR-003",
      "category": "performance",
      "requirement": "Authentication middleware validation latency must be minimal",
      "metric": "P95 latency < 10ms for JWT validation"
    },
    {
      "id": "NFR-004",
      "category": "security",
      "requirement": "Session cookies must have security flags set",
      "metric": "SameSite=Strict, Secure, HttpOnly flags set"
    },
    {
      "id": "NFR-005",
      "category": "security",
      "requirement": "Failed authentication attempts must be rate-limited",
      "metric": "Max 10 failed attempts per minute per IP"
    }
  ],
  "api_endpoints": [
    {
      "method": "POST",
      "path": "/mfa/webauthn/register/begin",
      "description": "Initiate WebAuthn credential registration",
      "roles": [
        "user",
        "admin"
      ]
    },
    {
      "method": "POST",
      "path": "/mfa/webauthn/register/finish",
      "description": "Complete WebAuthn credential registration",
      "roles": [
        "user",
        "admin"
      ]
    },
    {
      "method": "POST",
      "path": "/mfa/webauthn/login/begin",
      "description": "Initiate WebAuthn authentication",
      "roles": [
        "user",
        "admin"
      ]
    },
    {
      "method": "POST",
      "path": "/mfa/webauthn/login/finish",
      "description": "Complete WebAuthn authentication",
      "roles": [
        "user",
        "admin"
      ]
    },
    {
      "method": "GET",
      "path": "/mfa/webauthn/credentials",
      "description": "List user's WebAuthn credentials",
      "roles": [
        "user",
        "admin"
      ]
    },
    {
      "method": "DELETE",
      "path": "/mfa/webauthn/credentials/:id",
      "description": "Delete a WebAuthn credential",
      "roles": [
        "user",
        "admin"
      ]
    },
    {
      "method": "PUT",
      "path": "/mfa/webauthn/credentials/:id/name",
      "description": "Rename a WebAuthn credential",
      "roles": [
        "user",
        "admin"
      ]
    }
  ],
  "database_changes": [
    {
      "table": "webauthn_credentials",
      "action": "alter",
      "columns": [
        "user_id uuid NOT NULL (add CHECK constraint for ownership verification)"
      ]
    }
  ],
  "affected_services": [
    "identity-service",
    "mfa-service"
  ],
  "risks": [
    {
      "risk": "Breaking existing WebAuthn integrations that do not pass JWT tokens",
      "mitigation": "Provide migration guide and deprecation period. Add feature flag for gradual rollout."
    },
    {
      "risk": "CSRF protection may block legitimate cross-origin requests from admin console",
      "mitigation": "Configure trusted domain whitelist. Add preflight CORS handling for allowed origins."
    },
    {
      "risk": "JWT validation performance impact on high-volume authentication flows",
      "mitigation": "Implement JWT claims caching in Redis. Use connection pooling for Redis."
    },
    {
      "risk": "Session cookie handling complexity across multiple domains",
      "mitigation": "Use SameSite=None; Secure for cross-domain scenarios. Document cookie requirements clearly."
    },
    {
      "risk": "User ID parameter mismatch allowing privilege escalation",
      "mitigation": "Strict comparison of JWT subject with requested user_id. Audit log all mismatches."
    }
  ],
  "implementation_phases": [
    {
      "phase": 1,
      "name": "Authentication Middleware Integration",
      "tasks": [
        "Add internal/auth/middleware dependency to mfa package",
        "Create constructor accepting RBACMiddleware and TokenService",
        "Replace AuthMiddleware() with proper JWT validation",
        "Add unit tests for authentication scenarios"
      ]
    },
    {
      "phase": 2,
      "name": "CSRF Protection Implementation",
      "tasks": [
        "Integrate internal/common/middleware/csrf.go CSRFProtection",
        "Add CSRF token generation endpoint",
        "Implement double-submit cookie validation",
        "Add SameSite cookie configuration",
        "Add CSRF bypass for authenticated API clients (Bearer-only)"
      ]
    },
    {
      "phase": 3,
      "name": "User Ownership Verification",
      "tasks": [
        "Update HandleListCredentials to validate JWT subject",
        "Update HandleDeleteCredential with ownership checks",
        "Update HandleRenameCredential with ownership checks",
        "Remove user_id query parameter reliance (use from JWT)"
      ]
    },
    {
      "phase": 4,
      "name": "Testing and Documentation",
      "tasks": [
        "Add integration tests for protected endpoints",
        "Add security tests for CSRF bypass attempts",
        "Document API authentication requirements",
        "Update OpenAPI specification with security schemas"
      ]
    }
  ]
}