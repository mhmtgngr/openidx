{
  "risk_level": "high",
  "security_score": 42,
  "vulnerabilities": [
    {
      "id": "V-001",
      "severity": "critical",
      "file": "internal/oauth/handlers_passwordless.go",
      "description": "SQL injection via Redis key concatenation without validation",
      "fix": "Validate and sanitize mfa_session input before using in Redis key lookup"
    },
    {
      "id": "V-002",
      "severity": "high",
      "file": "internal/governance/zt_policy_handler.go",
      "description": "No rate limiting on policy evaluation endpoint - allows DoS",
      "fix": "Add rate limiting middleware to POST /api/v1/policies/evaluate"
    },
    {
      "id": "V-003",
      "severity": "high",
      "file": "internal/identity/handlers_federation.go",
      "description": "SQL injection via email domain concatenation in QueryRow",
      "fix": "Use parameterized queries with proper domain whitelist validation"
    },
    {
      "id": "V-004",
      "severity": "high",
      "file": "internal/identity/handlers_mfa.go",
      "description": "User ID from query/header without proper validation - IDOR vulnerability",
      "fix": "Require authenticated context user ID only, reject query/header overrides"
    },
    {
      "id": "V-005",
      "severity": "high",
      "file": "internal/identity/handlers_otp.go",
      "description": "Debug mode exposes OTP codes in production - enables account takeover",
      "fix": "Remove OTP code exposure entirely or require production flag check"
    },
    {
      "id": "V-006",
      "severity": "medium",
      "file": "internal/governance/zt_policy.go",
      "description": "Regex conditions in policies without input sanitization - ReDoS vulnerability",
      "fix": "Pre-compile and validate regex patterns before storage, limit complexity"
    },
    {
      "id": "V-007",
      "severity": "medium",
      "file": "internal/auth/middleware.go",
      "description": "Missing JWT algorithm verification - algorithm confusion attack possible",
      "fix": "Explicitly verify alg header equals RS256/ES256 only"
    },
    {
      "id": "V-008",
      "severity": "medium",
      "file": "internal/governance/workflows.go",
      "description": "ApprovalPolicy stores arbitrary JSON without schema validation - injection risk",
      "fix": "Define strict schema for ApprovalPolicy, validate all JSON fields"
    },
    {
      "id": "V-009",
      "severity": "medium",
      "file": "internal/audit/handler.go",
      "description": "No audit logging for audit queries - allows reconnaissance without detection",
      "fix": "Log all audit access with requester context"
    },
    {
      "id": "V-010",
      "severity": "low",
      "file": "internal/governance/policy.go",
      "description": "OPA policies loaded without signature verification - supply chain risk",
      "fix": "Implement policy signing and verification before loading"
    }
  ],
  "owasp_checks": [
    {
      "category": "A01:2021-Broken Access Control",
      "status": "fail",
      "detail": "IDOR in handlers_mfa.go allows user_id from query parameter"
    },
    {
      "category": "A02:2021-Cryptographic Failures",
      "status": "fail",
      "detail": "Debug OTP exposure in handlers_otp.go"
    },
    {
      "category": "A03:2021-Injection",
      "status": "fail",
      "detail": "SQL injection risk in handlers_federation.go via email domain"
    },
    {
      "category": "A04:2021-Insecure Design",
      "status": "fail",
      "detail": "No rate limiting on policy evaluation enables DoS"
    },
    {
      "category": "A05:2021-Security Misconfiguration",
      "status": "fail",
      "detail": "Debug mode may leak OTPs in production"
    },
    {
      "category": "A06:2021-Vulnerable and Outdated Components",
      "status": "pass",
      "detail": "No outdated dependencies detected in reviewed code"
    },
    {
      "category": "A07:2021-Identification and Authentication Failures",
      "status": "fail",
      "detail": "JWT algorithm validation missing in middleware"
    },
    {
      "category": "A08:2021-Software and Data Integrity Failures",
      "status": "fail",
      "detail": "OPA policies loaded without verification"
    },
    {
      "category": "A09:2021-Security Logging and Monitoring Failures",
      "status": "fail",
      "detail": "Audit queries not logged themselves"
    },
    {
      "category": "A10:2021-Server-Side Request Forgery",
      "status": "pass",
      "detail": "No SSRF patterns found in reviewed code"
    }
  ],
  "verdict": "NEEDS_FIXES",
  "critical_fixes": [
    "Fix SQL injection in handlers_federation.go by enforcing parameterized queries with domain whitelist",
    "Remove OTP code exposure from handlers_otp.go response",
    "Add JWT algorithm verification to auth middleware",
    "Remove query/header user_id override in handlers_mfa.go - enforce authenticated context only"
  ]
}