{
  "risk_level": "medium",
  "security_score": 72,
  "vulnerabilities": [
    {
      "id": "V-001",
      "severity": "high",
      "file": "internal/oauth/handlers_passwordless.go",
      "description": "Session validation regex allows dots and underscores which could be exploited for path traversal in Redis keys. While better than no validation, the pattern `[a-zA-Z0-9\\-_\\.]` is still permissive.",
      "fix": "Restrict to UUID format only: `^[a-f0-9\\-]{36}$` for JWT session IDs, or use a allowlist approach."
    },
    {
      "id": "V-002",
      "severity": "high",
      "file": "internal/governance/zt_policy_handler.go",
      "description": "In-memory rate limiting store is vulnerable to race conditions and DoS. The `rateLimitStore` uses global state which can be exhausted. No cleanup mechanism for expired entries.",
      "fix": "Use Redis with TTL for rate limiting, implement token bucket algorithm, add periodic cleanup goroutine."
    },
    {
      "id": "V-003",
      "severity": "medium",
      "file": "internal/governance/zt_policy.go",
      "description": "Condition Field accepts arbitrary strings via `Field string` - no validation against allowlist of valid fields (user.role, resource.type, etc.) enables potential injection into policy evaluation.",
      "fix": "Define allowlist of valid field names and validate before policy creation."
    },
    {
      "id": "V-004",
      "severity": "medium",
      "file": "internal/identity/handlers_federation.go",
      "description": "Domain validation regex allows multiple consecutive dots and could accept malformed domains that pass validation but cause downstream issues.",
      "fix": "Use stricter validation: `^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$` ensuring no consecutive dots."
    },
    {
      "id": "V-005",
      "severity": "medium",
      "file": "internal/auth/middleware.go",
      "description": "No evidence of token binding checks (e.g., comparing token `jti` or `sub` against request context) enabling potential token replay across sessions.",
      "fix": "Add token fingerprinting using client IP hash or session ID binding in claims."
    },
    {
      "id": "V-006",
      "severity": "medium",
      "file": "internal/audit/handler.go",
      "description": "Audit log integrity verification endpoint exists but no evidence of cryptographic signing (HMAC, digital signatures) for tamper evidence.",
      "fix": "Implement append-only cryptographic chain with hash chaining (each entry hashes previous entry's hash)."
    },
    {
      "id": "V-007",
      "severity": "low",
      "file": "internal/identity/handlers_otp.go",
      "description": "OTP code is conditionally exposed in response (comment warns but code path may exist in dev mode).",
      "fix": "Ensure OTP codes are never logged or returned in any environment."
    },
    {
      "id": "V-008",
      "severity": "medium",
      "file": "internal/governance/workflows.go",
      "description": "ApprovalPolicy uses `[]map[string]interface{}` for ApprovalSteps - untyped structure vulnerable to injection and schema drift.",
      "fix": "Define structured ApprovalStep type with explicit fields and validation."
    }
  ],
  "owasp_checks": [
    {
      "category": "A01:2021 \u2013 Broken Access Control",
      "status": "fail",
      "detail": "IDOR risk in MFA handlers - user_id from context not verified against token claims. Rate limiter vulnerable to bypass."
    },
    {
      "category": "A02:2021 \u2013 Cryptographic Failures",
      "status": "pass",
      "detail": "JWT validation appears correct, no hardcoded secrets visible."
    },
    {
      "category": "A03:2021 \u2013 Injection",
      "status": "fail",
      "detail": "SQL injection risk via domain validation bypass. No input sanitization on policy field names."
    },
    {
      "category": "A04:2021 \u2013 Insecure Design",
      "status": "fail",
      "detail": "In-memory rate limiting is not production-ready. No circuit breakers visible."
    },
    {
      "category": "A05:2021 \u2013 Security Misconfiguration",
      "status": "pass",
      "detail": "Proper use of zap logging, testcontainers for tests."
    },
    {
      "category": "A06:2021 \u2013 Vulnerable Components",
      "status": "pass",
      "detail": "Using up-to-date dependencies (gin v1.10+, pgx v5)."
    },
    {
      "category": "A07:2021 \u2013 Identification and Authentication Failures",
      "status": "fail",
      "detail": "No evidence of failed login throttling. Session validation regex permissive."
    },
    {
      "category": "A08:2021 \u2013 Software and Data Integrity Failures",
      "status": "fail",
      "detail": "Audit log integrity not cryptographically enforced."
    },
    {
      "category": "A09:2021 \u2013 Security Logging",
      "status": "pass",
      "detail": "Audit service present with structured logging."
    },
    {
      "category": "A10:2021 \u2013 Server-Side Request Forgery",
      "status": "pass",
      "detail": "No SSRF patterns visible in reviewed code."
    }
  ],
  "verdict": "NEEDS_FIXES",
  "critical_fixes": [
    "Implement Redis-based rate limiting with TTL and cleanup in zt_policy_handler.go",
    "Add cryptographic hash chaining to audit logs for tamper evidence",
    "Restrict session validation to UUID format only in handlers_passwordless.go",
    "Define structured ApprovalStep type to replace map[string]interface{} in workflows.go",
    "Add field name allowlist validation in ZTPolicy condition evaluation"
  ]
}